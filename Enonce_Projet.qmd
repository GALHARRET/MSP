---
title: "Projet 2025"
format: html
editor: visual
execute:
  echo: false
  eval: false
---

```{r}
library(pracma)
# Définir une matrice dont les colonnes sont les vecteurs de base
k=40
p=5
n=6
set.seed("3344")
A <- matrix(rnorm(p*p),nrow=p)
Q <- gramSchmidt(A)$Q
lambda=c(5,2,0.7,0.5,0.25)
S=t(Q)%*%diag(lambda)%*%Q
library(MASS)
mu=c(25,100,30,10,7)
X=array(NA,dim =c(k,p,n))
for(i in 1:n) X[,,i]=mvrnorm(k,mu,S)


colnames(X)=paste("caract.",1:p,sep="")
a=1.02
X[20,1,]=rnorm(n,a*mu[1],sqrt(diag(S)[1]))
X[20,2,]=rnorm(n,a*mu[2],sqrt(diag(S)[2]))
X[20,5,]=rnorm(n,a*mu[5],sqrt(diag(S)[5]))

a=1.05
X[30,4,]=rnorm(n,a*mu[4],sqrt(diag(S)[4]))
X[30,5,]=rnorm(n,a*mu[5],sqrt(diag(S)[5]))
#X[30,,]=mvrnorm(n,c(a*mu[1],mu[2],mu[3],mu[4],a*mu[5]),S)


a=1.5
X[40,2,]=rnorm(n,mu[2],a*sqrt(diag(S)[2]))
X[40,3,]=rnorm(n,mu[3],a*sqrt(diag(S)[3]))
X[40,4,]=rnorm(n,mu[4],a*sqrt(diag(S)[4]))
#X[40,,]=mvrnorm(n,c(mu[1],mu[2],mu[3],a*mu[4],mu[5]),S)


#GGally::ggpairs(as.data.frame(Moy_X(X)))
library(multiSPC)
save(X,file = "X.rda")
```

On considère le jeu de données [X](X.rda) qui correspond au suivi de 5 caractéristiques d'une production.

Les 15 premiers prélèvements ont été effectués pour les 10 min et vont servir à mettre en place les limites de contrôle. Les prélèvements suivants ont été réalisés 5 fois par jour durant 5 jours de production.

# Premier travail : cartes univariées

-   On calcule les limites des cartes sur les 15 premiers points :

```{r warning=FALSE, echo=TRUE, eval=TRUE}
library(multiSPC)
load("X.rda")
X1=X[1:15,,]
k1=dim(X1)[1]
p=dim(X1)[2]
n=dim(X1)[3]

M=S=matrix(NA,ncol=p,nrow=k1)

for(j in 1:p){
M[,j]=apply(X1[,j,],1,mean)
S[,j]=apply(X1[,j,],1,sd)
}
mu=apply(M,2,mean)
sig=apply(S,2,mean)
sigI=sig/c4(n)
LIC=mu-3*sigI/sqrt(n)
LSC=mu+3*sigI/sqrt(n)
graph1=list()
for(j in 1:p){
  graph1[[j]]=plot_chart(M[,j],LIC=LIC[j],LSC=LSC[j],Type = paste("caract.",j,sep=""))
}
graph1
```

Que peut-on en déduire ?

-   Appliquer les limites de contrôles sur les 25 autres prélèvements et interpréter les résultats.

```{r warning=FALSE}
X2=X[16:40,,]
k2=dim(X2)[1]
M=S=matrix(NA,ncol=p,nrow=k2)
for(j in 1:p){
M[,j]=apply(X2[,j,],1,mean)
}
graph2=list()
for(j in 1:p){
  graph2[[j]]=plot_chart(M[,j],LIC=LIC[j],LSC=LSC[j],Type = paste("caract.",j,sep=""))
}
graph2
```

# Deuxième travail approche multivariée pour la construction des limites (15 premiers prélèvements)

On va construire deux cartes de contrôle multivariée sur les 15 premières observations afin de calculer les limites de contrôle qui seront utilisées pour les prélèvements en routine (25 dans notre cas).

-   Construire le graphe des corrélations des 5 caractéristiques sur la matrice $\tilde X$ de dimension $(k,p)$ dont les élements $$\tilde x_{ij}=\frac1{n}\sum_{m=1}^n x_{ijm}.$$

Fonction Moy_X() dans le package *multiSPC*.

```{r}
Moy1=Moy_X(X1)
GGally::ggpairs(as.data.frame(Moy1))
```

-   Construire la carte de contrôle du $T^2$ de Hotelling. Que peut on en déduire ? Utiliser la fonction LSC_T2_Hotelling_kn() pour calculer les limites

```{r}
res1=T2_Hotelling_kn(X1)
LSC1=LSC_T2_Hotelling_kn(X1)
plot_chart(res1,LSC=LSC1[1],Type="T2 Hotelling")
```

-   Construire la carte de contrôle du $T^2$ de Hotelling sur composantes principales à partir de la matrice $\tilde X$ définie précédemment. Justifier le nombre de composantes choisies.

```{r}
resPC=Principal_Component_construction(Moy1,r=2,data2 = Moy_X(X2))
resPC$sing.values
resPC1=T2_Hotelling_k1(resPC$coord_PC1)
LSC2=LSC_T2_Hotelling_k1(resPC$coord_PC1)
plot_chart(resPC1,LSC=LSC2[1],Type="T2 Hotelling")
```

-   Que peut-on déduire de ces résultats ?

# Troisième travail approche multivariée pour la construction des cartes à partir des limites précédentes

Pour les 25 derniers prélèvements :

-   Construire la carte du $T^2$ de Hotelling en utilisant les limites Phase II obtenues à la question précédente.

```{r}
res2=T2_Hotelling_kn(X2,
                    MoyT=Moy_T(X1),
                    S=covariance_X(X1))
plot_chart(res2,LSC=LSC2[2],Type="T2 Hotelling")
```

-   Construire la carte du $T^2$ de Hotelling sur Composantes principales en utilisant les limites Phase II obtenues à la question précédente.

```{r}
resPC2=T2_Hotelling_k1(resPC$coord_PC2,
                       MoyT=Moy_T(resPC$coord_PC1),
                       S=covariance_X(resPC$coord_PC1))
plot_chart(resPC2,LSC=LSC2[2],Type="T2 Hotelling")
```

# Quatrième travail : Etude des points HC sur les cartes multivariées

-   Les points HC dans la carte du T2 seront étudiés en utilisant la fonction T2_Hotelling_kn_MYT() et en suivant la procédure décrite p20 du cours (CM2).

```{r}
## HC 1 variable
k_hc=which(res2>LSC1[2])
MTY1=matrix(NA,nrow=length(k_hc),ncol=p)
rownames(MTY1)=k_hc
colnames(MTY1)=colnames(X1)
for(i in 1:length(k_hc)){
  for(j in 1:p){
  mty1=T2_Hotelling_kn_MYT(k_hc[i],k=15,select = j,MoyT = Moy_T(X1),data = X2)
  MTY1[i,j]=as.numeric(mty1$T2>=mty1$LSC)
}
}
MTY1
## Pour k_hc=5, caract2 éliminée

## HC deux variables
MTY2=matrix(NA,nrow=p,ncol=p)
rownames(MTY2)=colnames(MTY2)=colnames(X1)
for(i in 1:(p-1)){
  for(j in (i+1):p){
  mty2=T2_Hotelling_kn_MYT(k_hc[1],k=15,select = c(i,j),MoyT = Moy_T(X1),data = X2)
  MTY2[i,j]=as.numeric(mty2$T2>=mty2$LSC)
}
}
MTY2
# Pour k_hc=5, caract 1, 3 et 4 éliminées


for(i in 1:(p-1)){
  for(j in (i+1):p){
  mty2=T2_Hotelling_kn_MYT(k_hc[2],k=15,select = c(i,j),MoyT = Moy_T(X1),data = X2)
  MTY2[i,j]=as.numeric(mty2$T2>=mty2$LSC)
}
}
MTY2
# Pour k_hc=15 caract 3 et 4 éliminées


for(i in 1:(p-1)){
  for(j in (i+1):p){
  mty2=T2_Hotelling_kn_MYT(k_hc[3],k=15,select = c(i,j),MoyT = Moy_T(X1),data = X2)
  MTY2[i,j]=as.numeric(mty2$T2>=mty2$LSC)
}
}
MTY2
# Pour k_hc=24 caract 3,4,5 éliminées



## HC 3 Variables

T2_Hotelling_kn_MYT(k_hc[2],k=15,select = c(1,2,5),MoyT = Moy_T(X1),data = X2)

```

-   Les points HC de la carte $T^2$ sur composantes principales seront étudiées par des cartes univariées sur les composantes principales. On interprêtera les résultats à partir du cercle de corrélation. Pour cette carte $\sigma_I$ sera égal à :

```{r echo=TRUE}
k2=dim(X2)[1]
sig_I=sqrt(resPC$var_expl_PC*(k2-1))[1:2]
```

```{r}
mu=apply(resPC$coord_PC1,2,mean)

plot_chart(resPC$coord_PC2[,1],LIC=mu[1]-3*sig[1]/sqrt(k),LSC=mu[1]+3*sig[1]/sqrt(k))
plot_chart(resPC$coord_PC2[,2],LIC=mu[2]-3*sig[2]/sqrt(k),LSC=mu[2]+3*sig[2]/sqrt(k))
```

# Conclusion

Conclure sur l'ensemble des résultats et interpréter les différences de résultats obtenus dans les différentes approches.
